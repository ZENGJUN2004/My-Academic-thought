<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦æœ¯åˆ†èº« - æ›¾å†›æ€ç»´å¼•æ“</title>
    <!-- å¼•å…¥æ–‡ä»¶è§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary-blue: #0056D2; /* æ·±è“ */
            --light-blue: #E3F2FD;   /* æµ…è“èƒŒæ™¯ */
            --bg-color: #F5F7FA;     /* ææµ…ç°ç™½ */
            --chat-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --thinking-bg: #f8f9fa;
            --thinking-border: #d1e7dd;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background-color: var(--chat-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            z-index: 10;
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span {
            color: var(--text-main);
            font-weight: 400;
            font-size: 16px;
        }

        .header-actions button {
            background: none;
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.2s;
        }
        .header-actions button:hover {
            background-color: var(--bg-color);
            color: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        /* ä¸»å¯¹è¯åŒºåŸŸ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .message.assistant .avatar {
            background-color: #000;
        }

        .message.user .avatar {
            background-color: var(--primary-blue);
        }

        .content {
            background-color: var(--chat-bg);
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.7;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            max-width: 85%;
        }

        .message.user .content {
            background-color: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.assistant .content {
            background-color: white;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 2px;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .thinking-block {
            background-color: var(--thinking-bg);
            border: 1px solid var(--thinking-border);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            font-size: 13px;
            color: #555;
        }

        .thinking-header {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(0,0,0,0.02);
            user-select: none;
            font-weight: 600;
        }
        
        .thinking-header:hover {
            background-color: rgba(0,0,0,0.04);
        }

        .thinking-content {
            padding: 10px 12px;
            border-top: 1px solid var(--thinking-border);
            white-space: pre-wrap;
            display: none; /* é»˜è®¤éšè— */
            line-height: 1.6;
            font-family: 'Consolas', monospace;
        }

        .thinking-content.open {
            display: block;
        }

        .arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }
        .arrow.open {
            transform: rotate(90deg);
        }

        /* åº•éƒ¨è¾“å…¥åŒº */
        .input-area {
            background-color: var(--chat-bg);
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
            display: flex;
            flex-direction: column;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-blue);
        }

        /* å·¥å…·æ  */
        .toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .tool-btn:hover {
            background-color: var(--bg-color);
            color: var(--primary-blue);
        }
        
        #fileInput { display: none; }

        textarea {
            width: 100%;
            border: none;
            resize: none;
            padding: 15px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            background: transparent;
            min-height: 50px;
            max-height: 200px;
        }

        .send-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .send-btn:hover { background-color: #0046b0; }
        .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .file-status {
            font-size: 12px;
            color: var(--primary-blue);
            margin-left: auto;
            align-items: center;
            display: none;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Markdown åŸºç¡€æ ·å¼ */
        .content strong { font-weight: 700; }
        .content p { margin: 0 0 10px 0; }
        .content p:last-child { margin: 0; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        ğŸ§  å­¦æœ¯åˆ†èº«ï¼š<span>åƒæ›¾å†›ä¸€æ ·æ€è€ƒ</span>
    </div>
    <div class="header-actions">
        <button onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
    </div>
</header>

<main id="chat-container">
    <!-- æ¬¢è¿è¯­ -->
    <div class="message assistant">
        <div class="avatar">AI</div>
        <div class="content">
            æ‚¨å¥½ï¼Œæˆ‘æ˜¯åŸºäºæ›¾å†›æ•™æˆå­¦æœ¯é£æ ¼å¾®è°ƒçš„æ™ºèƒ½åˆ†èº«ã€‚æˆ‘å¯ä»¥ååŠ©æ‚¨è¿›è¡Œæ–‡è‰ºç†è®ºåˆ†æã€æ–‡æœ¬æ¶¦è‰²æˆ–å­¦æœ¯å†™ä½œã€‚è¯·ä¸Šä¼ ç›¸å…³æ–‡çŒ®ï¼ˆPDF/Word/TXTï¼‰æˆ–ç›´æ¥å¼€å§‹å¯¹è¯ã€‚
        </div>
    </div>
</main>

<div class="input-area">
    <div class="input-wrapper">
        <div class="toolbar">
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
                ğŸ“ ä¸Šä¼ æ–‡ä»¶
            </button>
            <input type="file" id="fileInput" accept=".txt,.docx,.pdf">
            <div class="file-status" id="fileStatus"></div>
        </div>
        <textarea id="userInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
    </div>
</div>

<script>
    /**
     * é…ç½®åŒºåŸŸ
     */
    const CONFIG = {
        API_KEY: "sk-d901f4d443dd4b93acdccff48ed6d7be",
        MODEL_NAME: "qwen3-32b-ft-202601031456-a010-fcf97447",
        BASE_URL: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    };

    // åˆå§‹åŒ– PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // çŠ¶æ€ç®¡ç†
    let messageHistory = []; // å­˜å‚¨ä¸Šä¸‹æ–‡
    let currentFileContent = ""; // æš‚å­˜æ–‡ä»¶å†…å®¹
    
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = '50px';
    });

    // å›è½¦å‘é€
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    /**
     * æ–‡ä»¶å¤„ç†é€»è¾‘
     */
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        const statusEl = document.getElementById('fileStatus');
        if (!file) return;

        statusEl.style.display = 'flex';
        statusEl.innerText = `æ­£åœ¨è§£æ ${file.name}...`;

        try {
            let text = "";
            if (file.type === "application/pdf") {
                text = await parsePDF(file);
            } else if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({arrayBuffer});
                text = result.value;
            } else if (file.type === "text/plain") {
                text = await file.text();
            } else {
                throw new Error("ä¸æ”¯æŒçš„æ ¼å¼");
            }

            // æˆªæ–­ä¿æŠ¤
            if (text.length > 8000) {
                text = text.substring(0, 8000) + "\n\n[å†…å®¹è¿‡é•¿å·²æˆªæ–­]";
            }

            currentFileContent = text;
            statusEl.innerText = `âœ… å·²åŠ è½½: ${file.name}`;
            statusEl.style.color = "green";
            
            // å°†æ–‡ä»¶å†…å®¹æš‚å­˜ï¼Œå¾…ç”¨æˆ·ç‚¹å‡»å‘é€æ—¶ä¸€å¹¶æäº¤
            userInput.placeholder = `æ–‡ä»¶ ${file.name} å·²å°±ç»ªï¼Œè¯·è¾“å…¥æŒ‡ä»¤ç›´æ¥å‘é€...`;
            userInput.focus();

        } catch (err) {
            console.error(err);
            statusEl.innerText = "è§£æå¤±è´¥";
            statusEl.style.color = "red";
            alert("æ–‡ä»¶è§£æå¤±è´¥: " + err.message);
        }
    });

    async function parsePDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let fullText = "";
        const maxPages = Math.min(pdf.numPages, 30);
        for (let i = 1; i <= maxPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(item => item.str).join(' ') + "\n";
        }
        return fullText;
    }

    /**
     * å‘é€æ¶ˆæ¯æ ¸å¿ƒé€»è¾‘
     */
    async function sendMessage() {
        let text = userInput.value.trim();
        
        // å¦‚æœæœ‰æ–‡ä»¶å†…å®¹ï¼Œåˆå¹¶åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­
        if (currentFileContent) {
            text = `[ç³»ç»Ÿå‚è€ƒæ–‡æ¡£å†…å®¹]:\n${currentFileContent}\n\n[ç”¨æˆ·æŒ‡ä»¤]:\n${text}`;
            currentFileContent = ""; // æ¸…ç©ºç¼“å­˜
            document.getElementById('fileStatus').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        if (!text) return;

        // 1. UI æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addMessageToUI('user', text);
        userInput.value = '';
        userInput.style.height = '50px';
        sendBtn.disabled = true;

        // 2. åŠ å…¥å†å²è®°å½•
        messageHistory.push({ role: "user", content: text });

        // 3. åˆ›å»º AI å›å¤çš„å ä½ç¬¦
        const aiMessageId = 'msg-' + Date.now();
        const aiContentDiv = addMessageToUI('assistant', '', aiMessageId);
        
        // ç”¨äºå±•ç¤ºæ€è€ƒè¿‡ç¨‹
        let thinkingDiv = null;
        let thinkingContentDiv = null;

        try {
            // 4. å‘èµ·æµå¼è¯·æ±‚
            const response = await fetch(CONFIG.BASE_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL_NAME,
                    messages: messageHistory,
                    stream: true, // å¿…é¡»å¼€å¯æµå¼æ‰èƒ½ä½¿ç”¨æ€è€ƒæ¨¡å¼
                    enable_thinking: true, // å¼€å¯æ€è€ƒ
                    max_thinking_tokens: 2000, // è®¾ç½®æ€è€ƒ token ä¸Šé™
                    temperature: 0.3
                })
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullReasoning = "";
            let fullResponse = "";
            let isThinking = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.slice(6);
                        if (dataStr === '[DONE]') break;
                        
                        try {
                            const data = JSON.parse(dataStr);
                            const delta = data.choices[0].delta;

                            // å¤„ç†æ¨ç†å†…å®¹ {
                                if (!thinkingDiv) {
                                    // åˆå§‹åŒ–æ€è€ƒåŒºå— UI
                                    thinkingDiv = document.createElement('div');
                                    thinkingDiv.className = 'thinking-block';
                                    thinkingDiv.innerHTML = `
                                        <div class="thinking-header" onclick="toggleThinking(this)">
                                            <span class="arrow">â–¶</span> 
                                            <span>æ·±åº¦æ€è€ƒè¿‡ç¨‹ (æ¨ç†)</span>
                                        </div>
                                        <div class="thinking-content"></div>
                                    `;
                                    // æ’å…¥åˆ°å›å¤å†…å®¹çš„æœ€å‰é¢
                                    aiContentDiv.insertBefore(thinkingDiv, aiContentDiv.firstChild);
                                    thinkingContentDiv = thinkingDiv.querySelector('.thinking-content');
                                }
                                fullReasoning += delta.reasoning_content;
                                thinkingContentDiv.textContent = fullReasoning;
                                // è‡ªåŠ¨æ»šåŠ¨
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                            
                            // å¤„ç†æ™®é€šå›å¤å†…å®¹
                            if (delta.content) {
                                fullResponse += delta.content;
                                // å¦‚æœæœ‰æ€è€ƒå—ï¼Œå†…å®¹è¿½åŠ åˆ°æ€è€ƒå—åé¢ï¼Œå¦åˆ™ç›´æ¥è¿½åŠ 
                                // ç®€å•å¤„ç†ï¼šå…¨æ”¾åœ¨ä¸€ä¸ª div é‡Œï¼Œé€šè¿‡ CSS æ§åˆ¶å¸ƒå±€
                                // ä¸ºäº†è®©å†…å®¹åœ¨æ€è€ƒå—ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥è¿½åŠ åˆ° aiContentDiv
                                // ä½†å› ä¸ºæˆ‘ä»¬å‰é¢æ’å…¥äº† thinkingDivï¼Œæ‰€ä»¥ç›´æ¥ append å¯èƒ½ä¼šä¹±ã€‚
                                // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå®¹å™¨åŒ…ä½å®é™…å›å¤æ–‡æœ¬
                                let textSpan = aiContentDiv.querySelector('.text-response');
                                if (!textSpan) {
                                    textSpan = document.createElement('div');
                                    textSpan.className = 'text-response';
                                    aiContentDiv.appendChild(textSpan);
                                }
                                textSpan.innerText = fullResponse;
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }

                        } catch (e) {
                            console.error("Parse error", e);
                        }
                    }
                }
            }

            // å®Œæˆåï¼Œè‡ªåŠ¨å±•å¼€æ€è€ƒè¿‡ç¨‹ï¼ˆå¯é€‰ï¼‰
            if (thinkingDiv) {
                const header = thinkingDiv.querySelector('.thinking-header');
                toggleThinking(header);
            }

            // è®°å½•å®Œæ•´å›å¤åˆ°å†å²ï¼ˆæ³¨æ„ï¼šAPI å†å²è®°å½•é€šå¸¸ä¸åŒ…å« reasoning å­—æ®µï¼Œåªä¿å­˜æœ€ç»ˆå›å¤ï¼‰
            messageHistory.push({ role: "assistant", content: fullResponse });

        } catch (err) {
            aiContentDiv.innerHTML += `<br><span style="color:red">[è¯·æ±‚å¤±è´¥: ${err.message}]</span>`;
        } finally {
            sendBtn.disabled = false;
            userInput.focus();
        }
    }

    /**
     * UI è¾…åŠ©å‡½æ•°
     */
    function addMessageToUI(role, text, id = null) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        if (id) msgDiv.id = id;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerText = role === 'user' ? 'æˆ‘' : 'AI';

        const content = document.createElement('div');
        content.className = 'content';
        // æ”¯æŒ Markdown ç®€å•æ¢è¡Œ
        content.innerHTML = text.replace(/\n/g, '<br>');

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return content; // è¿”å›å†…å®¹å®¹å™¨ä»¥ä¾¿æµå¼è¿½åŠ 
    }

    // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º/éšè—
    window.toggleThinking = function(header) {
        const content = header.nextElementSibling;
        const arrow = header.querySelector('.arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // æ¸…ç©ºå¯¹è¯
    window.clearChat = function() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ")) {
            messageHistory = [];
            chatContainer.innerHTML = '';
            // é‡æ–°æ·»åŠ æ¬¢è¿è¯­
            setTimeout(() => {
                addMessageToUI('assistant', 'å¯¹è¯å·²é‡ç½®ã€‚æˆ‘æ˜¯å­¦æœ¯åˆ†èº«ï¼Œè¯·éšæ—¶æé—®ã€‚');
            }, 100);
        }
    }
</script>

</body>
</html>
