<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡è‰ºç†è®ºæ™ºèƒ½å·¥ä½œç«™ - å…¨æ ¼å¼ç‰ˆ</title>
    <!-- å¼•å…¥æ–‡ä»¶è§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #8c1c13; 
            --bg-color: #f4f1ea; 
            --sidebar-color: #2c3e50; 
        }
        
        body { 
            font-family: 'PingFang SC', 'Microsoft YaHei', serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        #sidebar { 
            width: 320px; 
            background-color: var(--sidebar-color); 
            color: white; 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.2); 
            box-sizing: border-box;
            flex-shrink: 0;
        }

        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        #main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            overflow: hidden; 
            box-sizing: border-box;
        }

        .container { 
            background: white; 
            border-radius: 8px; 
            padding: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            box-sizing: border-box;
        }

        h2 { 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 10px; 
            margin-top: 0; 
            font-size: 20px;
        }

        h3, h4 { margin-top: 0; font-weight: 500; }

        textarea { 
            width: 100%; 
            height: 250px; 
            margin: 15px 0; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            resize: none; 
            font-size: 15px; 
            line-height: 1.6; 
            background-color: #fffcf5; 
            box-sizing: border-box;
            font-family: inherit;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold; 
            transition: all 0.3s; 
            display: inline-block;
            text-align: center;
        }
        .btn:hover { background-color: #a0231a; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ä¾§è¾¹æ æŒ‰é’®æ ·å¼ */
        .btn-secondary { 
            background-color: rgba(255,255,255,0.1); 
            margin-bottom: 10px; 
            width: 100%; 
            font-size: 14px; 
            text-align: left; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover { 
            background-color: rgba(255,255,255,0.2); 
        }

        /* è¾“å‡ºåŒºåŸŸæ ·å¼ */
        #output { 
            flex: 1; 
            margin-top: 20px; 
            padding: 20px; 
            background: #fdfdfd; 
            border: 1px solid #eee; 
            border-left: 5px solid var(--primary-color); 
            overflow-y: auto; 
            white-space: pre-wrap; 
            line-height: 1.8; 
            font-size: 15px; 
            color: #333;
        }

        /* ä¾§è¾¹æ æ–‡ä»¶æ¡† */
        .file-box { 
            background: rgba(255,255,255,0.1); 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
        }

        #status { 
            font-size: 12px; 
            color: #f1c40f; 
            margin-top: 8px; 
            min-height: 1.2em;
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-msg { 
            color: #c0392b; 
            background: #fdecea; 
            padding: 15px; 
            border-radius: 4px; 
            border: 1px solid #fadbd8; 
            line-height: 1.5;
        }

        /* è¾“å…¥æ¡†æ ·å¼ä¿®æ­£ */
        input[type="file"] {
            color: white;
            font-size: 13px;
            margin-top: 5px;
        }
        input[type="file"]::webkit-file-upload-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>âš™ï¸ ç ”ç©¶å·¥ä½œç«™</h3>
    
    <div class="file-box">
        <h4>ğŸ“‚ ç´ æå¯¼å…¥</h4>
        <input type="file" id="fileInput" accept=".txt,.docx,.pdf">
        <div id="status">æ”¯æŒ TXT, DOCX, PDF</div>
    </div>
    
    <h4>ğŸ“ æ™ºèƒ½æŒ‡ä»¤</h4>
    <button class="btn btn-secondary" onclick="setTask('æ¶¦è‰²')">âœ¨ å­¦æœ¯è¯­è¨€æ¶¦è‰²</button>
    <button class="btn btn-secondary" onclick="setTask('è¿ç§»')">âœï¸ æ–‡ç¨¿é£æ ¼è¿ç§»</button>
    <button class="btn btn-secondary" onclick="setTask('å¤§çº²')">ğŸ“‹ è‡ªåŠ¨æ‹Ÿå®šæçº²</button>
</div>

<div id="main-content">
    <div class="container">
        <h2>ğŸ­ ç†è®ºåˆ†æä¸å†™ä½œ</h2>
        
        <textarea id="userInput" placeholder="ç´ æè§£æå†…å®¹å°†æ˜¾ç¤ºåœ¨æ­¤å¤„..."></textarea>
        
        <div style="text-align: right;">
            <button id="submitBtn" class="btn" onclick="askAI()">å¼€å§‹æ·±åº¦å¯¹è¯ / å¤„ç†</button>
        </div>

        <div id="output">ç»“æœå°†åœ¨æ­¤å¤„å‘ˆç°...</div>
    </div>
</div>

<script>
    /**
     * é…ç½®åŒºåŸŸ
     * è¯·ç¡®ä¿æ‚¨çš„ API Key å’Œæ¨¡å‹åç§°æ­£ç¡®å¡«å†™åœ¨æ­¤å¤„
     */
    const CONFIG = {
        API_KEY: "sk-d901f4d443dd4b93acdccff48ed6d7be", // æ‚¨çš„ API Key
        MODEL_NAME: "qwen3-32b-ft-202601031456-a010-fcf97447", // ä¿®æ­£åçš„æ¨¡å‹åç§°
        BASE_URL: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    };

    // åˆå§‹åŒ– PDF.js Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    /**
     * æ™ºèƒ½æŒ‡ä»¤ç‚¹å‡»å¤„ç†
     */
    function setTask(type) {
        const input = document.getElementById('userInput');
        const prompts = {
            'æ¶¦è‰²': "è¯·è¿ç”¨æ·±åšçš„æ–‡è‰ºç†è®ºåŠŸåº•ï¼Œå¯¹ä»¥ä¸‹å†…å®¹è¿›è¡Œå­¦æœ¯åŒ–æ¶¦è‰²ï¼Œæå‡å…¶ç†è®ºæ·±åº¦ä¸é€»è¾‘æ€§ï¼š\n\n",
            'è¿ç§»': "è¯·å°†ä»¥ä¸‹å†…å®¹æ”¹å†™ä¸ºå­¦æœ¯è§„èŒƒçš„æ–‡è‰ºæ‰¹è¯„é£æ ¼ï¼Œæ³¨é‡æœ¯è¯­å‡†ç¡®æ€§ä¸è®ºè¯ä¸¥å¯†æ€§ï¼š\n\n",
            'å¤§çº²': "è¯·åŸºäºä»¥ä¸‹ç´ æï¼Œè®¾è®¡ä¸€ä»½é€»è¾‘ä¸¥å¯†ã€ç»“æ„æ¸…æ™°çš„å­¦æœ¯è®ºæ–‡å¤§çº²ï¼š\n\n"
        };
        
        // å¦‚æœå½“å‰æ¡†å†…æœ‰å†…å®¹ï¼Œä¸”ä¸æ˜¯ä»¥å‰ç¼€å¼€å¤´çš„ï¼Œåˆ™è¿½åŠ ï¼Œå¦åˆ™è¦†ç›–
        const prefix = prompts[type];
        if (input.value && !input.value.startsWith(prefix)) {
            input.value = prefix + input.value;
        } else if (!input.value.startsWith(prefix)) {
            input.value = prefix + input.value;
        }
    }

    /**
     * æ–‡ä»¶è¯»å–ä¸è§£æé€»è¾‘
     */
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        const statusEl = document.getElementById('status');
        const inputEl = document.getElementById('userInput');
        
        if (!file) return;

        statusEl.innerText = `æ­£åœ¨è§£æ ${file.name}...`;
        statusEl.style.color = "#f1c40f";
        
        try {
            let text = "";
            
            if (file.type === "application/pdf") {
                text = await parsePDF(file);
            } else if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({arrayBuffer});
                text = result.value;
            } else if (file.type === "text/plain") {
                text = await file.text();
            } else {
                throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
            }

            // æˆªæ–­è¿‡é•¿æ–‡æœ¬ä»¥å…è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶ (å¯é€‰)
            if (text.length > 15000) {
                text = text.substring(0, 15000) + "\n\n[æç¤º: å†…å®¹è¿‡é•¿ï¼Œå·²è‡ªåŠ¨æˆªæ–­å‰15000å­—]";
            }

            inputEl.value = text;
            statusEl.innerText = `âœ… ${file.name} è§£ææˆåŠŸï¼`;
            statusEl.style.color = "#2ecc71";

        } catch (err) {
            console.error(err);
            statusEl.innerText = `âŒ è§£æå¤±è´¥: ${err.message}`;
            statusEl.style.color = "#e74c3c";
            alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€‚");
        }
    });

    /**
     * è§£æ PDF æ–‡ä»¶
     */
    async function parsePDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let fullText = "";
        
        // é™åˆ¶æœ€å¤§é¡µæ•°è§£æï¼Œé˜²æ­¢å¡æ­»
        const maxPages = Math.min(pdf.numPages, 50); 

        for (let i = 1; i <= maxPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const pageText = content.items.map(item => item.str).join(' ');
            fullText += `--- ç¬¬ ${i} é¡µ ---\n${pageText}\n\n`;
        }
        
        if (pdf.numPages > 50) {
            fullText += "\n[æç¤º: æ–‡æ¡£è¶…è¿‡50é¡µï¼Œä»…è§£æäº†å‰50é¡µã€‚]";
        }
        
        return fullText;
    }

    /**
     * AI è°ƒç”¨é€»è¾‘
     */
    async function askAI() {
        const userInput = document.getElementById('userInput').value.trim();
        const outputDiv = document.getElementById('output');
        const submitBtn = document.getElementById('submitBtn');

        if (!userInput) {
            alert("è¯·å…ˆæä¾›ç´ ææˆ–è¾“å…¥å†…å®¹");
            return;
        }

        // UI çŠ¶æ€æ›´æ–°
        outputDiv.innerText = "æ­£åœ¨è°ƒåŠ¨å¾®è°ƒæ¨¡å‹è¿›è¡Œç†è®ºæ€ç»´ï¼Œè¯·ç¨å€™...";
        outputDiv.style.color = "var(--primary-color)";
        submitBtn.disabled = true;
        submitBtn.innerText = "å¤„ç†ä¸­...";

        try {
            const response = await fetch(CONFIG.BASE_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL_NAME,
                    messages: [
                        { 
                            "role": "system", 
                            "content": "ä½ æ˜¯ä¸€ä½æ–‡è‰ºç†è®ºç ”ç©¶ä¸“å®¶ï¼Œæ“…é•¿å­¦æœ¯æ¶¦è‰²ã€ç†è®ºå»ºæ„ä¸æ·±åº¦æ–‡æœ¬åˆ†æã€‚è¯·ç›´æ¥è¾“å‡ºåˆ†æç»“æœï¼Œæ— éœ€å¯’æš„ã€‚" 
                        },
                        { "role": "user", "content": userInput }
                    ],
                    // å…³é”®ä¿®å¤ï¼šæ˜¾å¼è®¾ç½® enable_thinking ä¸º false
                    // è¿™æ˜¯ä¸ºäº†è§£å†³ qwen3-32b æ¨¡å‹åœ¨éæµå¼è°ƒç”¨ä¸‹çš„æŠ¥é”™é—®é¢˜
                    enable_thinking: false, 
                    temperature: 0.3
                })
            });

            const data = await response.json();

            // é”™è¯¯å¤„ç†
            if (!response.ok) {
                throw new Error(data.error?.message || `HTTP Error: ${response.status}`);
            }

            // æ£€æŸ¥è¿”å›æ ¼å¼
            if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                const resultText = data.choices[0].message.content;
                outputDiv.innerText = resultText;
                outputDiv.style.color = "#333";
            } else {
                throw new Error("API è¿”å›çš„æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œæœªæ‰¾åˆ° content å­—æ®µã€‚");
            }

        } catch (err) {
            console.error("API Error:", err);
            outputDiv.innerHTML = `<div class="error-msg">
                <strong>âŒ è°ƒç”¨å¤±è´¥ï¼š</strong><br>
                ${err.message}<br><br>
                <small>å»ºè®®æ£€æŸ¥ï¼š1. ç½‘ç»œè¿æ¥ï¼›2. API Key æ˜¯å¦æœ‰æ•ˆï¼›3. æ¨¡å‹æ˜¯å¦å·²æˆåŠŸéƒ¨ç½²ã€‚</small>
            </div>`;
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false;
            submitBtn.innerText = "å¼€å§‹æ·±åº¦å¯¹è¯ / å¤„ç†";
        }
    }
</script>
</body>
</html>
