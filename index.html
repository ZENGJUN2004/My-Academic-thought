<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦æœ¯åˆ†èº« - æ›¾å†›æ€ç»´å¼•æ“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --primary-blue: #0056D2; 
            --bg-color: #F5F7FA;     
            --chat-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --thinking-bg: #f8f9fb;
            --thinking-border: #e0e8f0;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'STSong', 'SimSun', 'PingFang SC', serif; /* åå‘å­¦æœ¯æ’ç‰ˆçš„å®‹ä½“é£æ ¼ */
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background-color: var(--chat-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .brand span { color: var(--text-main); font-weight: 500; }

        .header-actions button {
            background: white;
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.2s;
        }
        .header-actions button:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

        /* èŠå¤©åŒºåŸŸ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        .message.user { flex-direction: row-reverse; }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .assistant .avatar { background: white; border: 2px solid var(--primary-blue); color: var(--primary-blue); }
        .user .avatar { background: #333; color: white; }

        .content {
            max-width: 85%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bubble {
            padding: 18px 24px;
            border-radius: 4px; /* å‡å°åœ†è§’ï¼Œå¢å¼ºå­¦æœ¯ä¸¥è°¨æ„Ÿ */
            font-size: 16px;
            line-height: 1.8;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            text-align: justify; /* ä¸¤ç«¯å¯¹é½ */
        }

        .user .bubble {
            background-color: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .assistant .bubble {
            background-color: white;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 2px;
            /* å»é™¤åˆ—è¡¨æ ·å¼ï¼Œå¼ºåˆ¶æ™®é€šæ–‡æœ¬å±•ç¤º */
        }

        /* è‡ªåŠ¨å±•å¼€çš„æ€è€ƒå—æ ·å¼ */
        .thinking-block {
            background-color: var(--thinking-bg);
            border: 1px solid var(--thinking-border);
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .thinking-header {
            padding: 8px 12px;
            cursor: pointer;
            color: #607d8b;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            font-weight: 500;
        }
        .thinking-content {
            padding: 10px 12px;
            color: #78909c;
            display: none; /* é»˜è®¤éšè—ç”±JSæ§åˆ¶å¼€å¯ */
            white-space: pre-wrap;
            border-top: 1px dashed #e0e8f0;
        }
        .thinking-content.open { display: block; }
        .arrow { transition: transform 0.2s; font-size: 10px; display: inline-block; }
        .arrow.open { transform: rotate(90deg); }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            background-color: white;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
            transition: border-color 0.2s;
        }
        .input-wrapper:focus-within { border-color: var(--primary-blue); }

        .toolbar {
            padding: 8px 15px;
            border-bottom: 1px solid #f9f9f9;
            display: flex;
            align-items: center;
        }
        .tool-btn {
            background: #f0f4ff;
            border: none;
            color: var(--primary-blue);
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        .file-status { font-size: 12px; margin-left: 10px; color: #2e7d32; display: none; }

        .input-body { display: flex; align-items: flex-end; padding: 10px 15px; }
        textarea {
            flex: 1;
            border: none;
            resize: none;
            padding: 5px 0;
            font-size: 15px;
            outline: none;
            min-height: 24px;
            max-height: 200px;
            background: transparent;
            font-family: inherit;
        }
        .send-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-btn:disabled { background: #ccc; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div class="logo-icon">æ–‡</div>
        <span>å­¦æœ¯åˆ†èº«ï¼š<span>åƒæ›¾å†›ä¸€æ ·æ€è€ƒ</span></span>
    </div>
    <div class="header-actions">
        <button onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†</button>
    </div>
</header>

<main id="chat-container"></main>

<div class="input-area">
    <div class="input-wrapper">
        <div class="toolbar">
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šä¼ æ–‡çŒ® (PDF/Word/TXT)</button>
            <input type="file" id="fileInput" accept=".txt,.docx,.pdf" style="display:none">
            <span id="fileStatus" class="file-status"></span>
        </div>
        <div class="input-body">
            <textarea id="userInput" placeholder="åœ¨æ­¤è¾“å…¥å­¦æœ¯è®®é¢˜..." rows="1"></textarea>
            <button id="sendBtn" class="send-btn" onclick="handleSend()">â¤</button>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        API_KEY: "sk-d901f4d443dd4b93acdccff48ed6d7be",
        MODEL_NAME: "qwen3-32b-ft-202601031456-a010-fcf97447",
        BASE_URL: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    };

    let messageHistory = [];
    let currentFileContext = "";
    let isGenerating = false;

    window.onload = () => {
        addMessageToUI('assistant', 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ›¾å†›çš„å­¦æœ¯åˆ†èº«ã€‚æˆ‘ä»¬å¯ä»¥å°±æ–‡è‰ºç†è®ºé—®é¢˜å±•å¼€æ·±å…¥çš„å­¦æœ¯æ¢è®¨ã€‚è¯·ä¸Šä¼ ç›¸å…³æ–‡çŒ®èµ„æ–™æˆ–ç›´æ¥æå‡ºæ‚¨å…³å¿ƒçš„ç†è®ºå‘½é¢˜ã€‚');
    };

    const textarea = document.getElementById('userInput');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // è¾…åŠ©å‡½æ•°ï¼šå»é™¤ Markdown ç¬¦å·å¹¶æ ¼å¼åŒ–ä¸ºå­¦æœ¯æ®µè½
    function formatAcademicText(text) {
        // ç§»é™¤ Markdown å¸¸è§çš„æçº²ç¬¦å·ï¼ˆ#ï¼Œ*ï¼Œ-ï¼Œæ•°å­—åˆ—è¡¨ç­‰ï¼‰
        let clean = text.replace(/[#*`\-_]/g, '');
        // ç§»é™¤å¤šä½™çš„æ•°å­—æçº²å¼€å¤´çš„ç©ºæ ¼
        clean = clean.replace(/^\s*\d+\.\s*/gm, '');
        // å¤„ç†æ¢è¡Œç¬¦ï¼Œå°†ä¸¤ä¸ªæ¢è¡Œç¬¦è½¬åŒ–ä¸ºæ®µè½ï¼ˆé¦–è¡Œç¼©è¿›è§†è§‰æ•ˆæœï¼‰
        return clean.split('\n').filter(p => p.trim() !== '').map(p => `&emsp;&emsp;${p.trim()}`).join('<br><br>');
    }

    async function handleSend() {
        if (isGenerating) return;
        const text = textarea.value.trim();
        if (!text && !currentFileContext) return;

        // ç³»ç»ŸæŒ‡ä»¤å¢å¼ºï¼šå¼ºåˆ¶å­¦æœ¯å†™ä½œé£æ ¼
        const academicPrompt = "è¯·ä»¥æ›¾å†›æ•™æˆçš„å£å»ï¼Œé‡‡ç”¨ä¸¥è°¨ã€è¿è´¯çš„å­¦æœ¯è®ºæ–‡å†™ä½œé£æ ¼è¿›è¡Œè®ºè¿°ã€‚ä¸¥ç¦ä½¿ç”¨æçº²ã€åˆ—è¡¨ã€åŠ ç²—ã€Markdownæ ‡é¢˜æˆ–ä»»ä½•éå™äº‹æ€§çš„æ’ç‰ˆã€‚è¯·ä½¿ç”¨é•¿æ®µè½è¿›è¡Œç†è®ºé˜å‘ã€‚";

        let fullInput = text;
        if (currentFileContext) {
            fullInput = `ã€å­¦æœ¯èƒŒæ™¯ææ–™ã€‘ï¼š\n${currentFileContext}\n\nã€è®ºé¢˜ã€‘ï¼š\n${text || "å¯¹è¯¥æ–‡çŒ®è¿›è¡Œç†è®ºåˆ†æ"}\n\nã€å†™ä½œè¦æ±‚ã€‘ï¼š${academicPrompt}`;
        } else {
            fullInput = `${text}\n\nã€å†™ä½œè¦æ±‚ã€‘ï¼š${academicPrompt}`;
        }

        addMessageToUI('user', text || "æäº¤æ–‡çŒ®åˆ†æ");
        textarea.value = '';
        textarea.style.height = 'auto';
        
        messageHistory.push({ role: "user", content: fullInput });
        const aiMsgDiv = addMessageToUI('assistant', '');
        const bubble = aiMsgDiv.querySelector('.bubble');
        bubble.innerHTML = ''; 

        isGenerating = true;
        document.getElementById('sendBtn').disabled = true;

        try {
            const response = await fetch(CONFIG.BASE_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL_NAME,
                    messages: messageHistory,
                    stream: true,
                    enable_thinking: true
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            let fullReasoning = "";
            
            let thinkingBox = null;
            let textContainer = document.createElement('div');
            bubble.appendChild(textContainer);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.trim() || line.includes('[DONE]')) continue;
                    if (!line.startsWith('data: ')) continue;

                    try {
                        const data = JSON.parse(line.slice(6));
                        const delta = data.choices[0].delta;

                        // å¤„ç†æ¨ç†å†…å®¹
                        if (delta.reasoning_content) {
                            if (!thinkingBox) {
                                thinkingBox = document.createElement('div');
                                thinkingBox.className = 'thinking-block';
                                thinkingBox.innerHTML = `
                                    <div class="thinking-header" onclick="toggleThinking(this)">
                                        <span class="arrow open">â–¼</span> æ·±åº¦æ€è€ƒ
                                    </div>
                                    <div class="thinking-content open"></div> `;
                                bubble.insertBefore(thinkingBox, textContainer);
                            }
                            fullReasoning += delta.reasoning_content;
                            thinkingBox.querySelector('.thinking-content').textContent = fullReasoning;
                        }

                        // å¤„ç†æ­£æ–‡å†…å®¹
                        if (delta.content) {
                            fullText += delta.content;
                            // åŠ¨æ€æ¸²æŸ“æ—¶æŒç»­æ¸…æ´— Markdown å¹¶æŒ‰æ®µè½æ’ç‰ˆ
                            textContainer.innerHTML = formatAcademicText(fullText);
                        }
                        
                        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
                    } catch (e) {}
                }
            }
            messageHistory.push({ role: "assistant", content: fullText });
        } catch (err) {
            bubble.innerHTML += `<div style="color:red">è¿æ¥å¤±è´¥: ${err.message}</div>`;
        } finally {
            isGenerating = false;
            document.getElementById('sendBtn').disabled = false;
            currentFileContext = ""; 
        }
    }

    function addMessageToUI(role, text) {
        const container = document.getElementById('chat-container');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;

        const avatarIcon = role === 'user' ? 'ç”¨æˆ·' : 'æ›¾';
        msgDiv.innerHTML = `
            <div class="avatar">${avatarIcon}</div>
            <div class="content">
                <div class="bubble">${role === 'assistant' ? formatAcademicText(text) : text}</div>
            </div>
        `;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
        return msgDiv;
    }

    window.toggleThinking = (header) => {
        const content = header.nextElementSibling;
        const arrow = header.querySelector('.arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
        arrow.innerHTML = content.classList.contains('open') ? 'â–¼' : 'â–¶';
    };

    window.clearChat = () => {
        if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å¿†å—ï¼Ÿ')) {
            messageHistory = [];
            document.getElementById('chat-container').innerHTML = '';
            addMessageToUI('assistant', 'å¯¹è¯è®°å¿†å·²é‡ç½®ã€‚');
        }
    };

    // æ–‡ä»¶å¤„ç†ä¿æŒä¸å˜
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const status = document.getElementById('fileStatus');
        status.style.display = 'inline';
        status.innerText = "â³ æ­£åœ¨è§£ææ–‡çŒ®...";

        try {
            let text = "";
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                for(let i=1; i<=Math.min(pdf.numPages, 30); i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join('') + "\n";
                }
            } else if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({arrayBuffer});
                text = result.value;
            } else {
                text = await file.text();
            }
            currentFileContext = text.substring(0, 20000); 
            status.innerText = "âœ… æ–‡çŒ®è§£ææˆåŠŸ: " + file.name;
        } catch (err) {
            status.innerText = "âŒ è§£æå¤±è´¥";
        }
    });
</script>
</body>
</html>